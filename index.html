<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AFD→ANVA Mapping Tool</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --muted:#7b8aa0; --text:#e8edf4; --accent:#82d1ff; --accent2:#a2ffdf;
      --ok:#34d399; --warn:#f59e0b; --err:#ef4444; --chip:#1e293b;
    }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,sans-serif;background:linear-gradient(180deg,#081018, #0c121b);color:var(--text)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 6px}
    p.subtitle{margin:0 0 18px;color:var(--muted)}
    .card{background:var(--panel);border:1px solid #1b2533;border-radius:16px;box-shadow:0 6px 30px rgb(0 0 0 / .25)}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){.row{grid-template-columns:1fr 1fr}}
    .section{padding:16px;border-top:1px solid #1b2533}
    .section:first-child{border-top:0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=file]{width:100%;padding:10px;border:1px dashed #2a3649;background:#0e1520;color:var(--text);border-radius:12px}
    button{appearance:none;border:0;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#051218;font-weight:600;padding:10px 14px;border-radius:12px;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .ghost{background:#172130;color:var(--text);border:1px solid #2a3649}
    .muted{color:var(--muted)}
    .stats{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .chip{background:var(--chip);border:1px solid #2a3649;color:var(--text);padding:6px 10px;border-radius:999px;font-size:12px}
    .log{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;background:#0c121b;border:1px solid #1b2533;border-radius:12px;padding:10px;max-height:200px;overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1b2533;text-align:left}
    th{position:sticky;top:0;background:#101827;z-index:1}
    .scroll{max-height:420px;overflow:auto;border:1px solid #1b2533;border-radius:12px}
    .right{float:right}
    .success{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}
  </style>
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>AFD → ANVA Mapping Tool</h1>
    <p class="subtitle">Selecteer je bestanden en bouw de mapping. Bij <b>dubbele AFD-waarden</b> krijgt de rij met <b>OAI=1</b> prioriteit; bij <b>unieke</b> AFD wordt de rij altijd gebruikt (OAI genegeerd).</p>

    <div class="card">
      <div class="section row">
        <div>
          <label>ANVA_AFD.xlsx (verplicht)</label>
          <input type="file" id="anvaFile" accept=".xlsx,.xls" />
        </div>
        <div>
          <label>Codelist.afm.csv (optioneel)</label>
          <input type="file" id="codelistFile" accept=".csv" />
        </div>
        <div>
          <label>data.csv (optioneel)</label>
          <input type="file" id="dataFile" accept=".csv" />
        </div>
        <div style="align-self:end;display:flex;gap:8px;flex-wrap:wrap">
          <button id="buildBtn" disabled>Bouwen</button>
          <button id="resetBtn" class="ghost">Reset</button>
          <span class="muted" id="readyLbl">Bestanden selecteren…</span>
        </div>
      </div>

      <div class="section">
        <div class="stats" id="stats"></div>
        <div class="log" id="log" hidden></div>
      </div>

      <div class="section">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button id="dlCsvBtn" class="ghost" disabled>Download mapping (CSV)</button>
          <button id="dlJsonBtn" class="ghost" disabled>Download mapping (JSON)</button>
          <span class="muted">Voorbeeld van de eerste 250 regels hieronder.</span>
        </div>
        <div class="scroll">
          <table id="tbl" hidden>
            <thead>
              <tr>
                <th>AFD</th>
                <th>ANVA</th>
                <th>ANVA Omschrijving</th>
                <th>Afwijkend niet toegestaan</th>
                <th>Bron (OAI)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const qs = (s, r=document) => r.querySelector(s);
    const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
    const logEl = qs('#log');
    const statsEl = qs('#stats');
    const tbl = qs('#tbl');
    const tbody = tbl.querySelector('tbody');

    let anvaRows = [];
    let mapping = new Map();

    const isOAI1 = (v) => {
      if (v === undefined || v === null) return false;
      if (v === 1 || v === '1' || v === true) return true;
      const s = String(v).trim().toUpperCase();
      return s === 'J' || s === 'Y';
    };

    const normalizeHeaders = (obj) => {
      const map = {};
      for (const [k, v] of Object.entries(obj)) {
        if (v == null) continue;
        const kk = String(k).trim().toLowerCase();
        map[kk] = v;
      }
      // Kandidaten
      const afd = map['afd'] ?? map['afd-code'] ?? map['afd code'];
      const anva = map['anva'] ?? map['anva code'] ?? map['code'];
      const oms = map['anva omschrijving'] ?? map['omschrijving'] ?? map['anva_omschrijving'];
      const afwijk = map['afwijkend niet toegestaan'] ?? map['afwijkend_niet_toegestaan'] ?? map['afwijkend'];
      const oai = map['oai'] ?? map['o.a.i'] ?? map['oai-voorkeur'] ?? map['voorkeur'] ?? map['is default'];
      return { afd, anva, oms, afwijk, oai };
    };

    function addStat(label, value, cls=''){
      const el = document.createElement('div');
      el.className = 'chip ' + cls;
      el.textContent = `${label}: ${value}`;
      statsEl.appendChild(el);
    }

    function setReadyState(){
      const ready = !!qs('#anvaFile').files[0];
      qs('#buildBtn').disabled = !ready;
      qs('#readyLbl').textContent = ready ? 'Klaar om te bouwen' : 'Bestanden selecteren…';
    }

    qsa('input[type=file]').forEach(i => i.addEventListener('change', setReadyState));
    qs('#resetBtn').addEventListener('click', () => location.reload());

    async function readXlsx(file){
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type:'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
      return json;
    }
    function readCsv(file){
      return new Promise((resolve, reject) => {
        Papa.parse(file, { header:true, skipEmptyLines:true, complete: r => resolve(r.data), error: reject });
      });
    }

    function buildMappingFromAnvaRows(rows){
      // 1) Groepeer per AFD
      const byAfd = new Map();
      for (const raw of rows){
        const { afd, anva, oms, afwijk, oai } = normalizeHeaders(raw);
        if (!afd || !anva) continue;
        const r = { afd:String(afd), anva:String(anva), oms:String(oms||''), afwijk:String(afwijk||''), oai };
        const arr = byAfd.get(r.afd) || [];
        arr.push(r); byAfd.set(r.afd, arr);
      }

      // 2) Selectie-regel
      const out = new Map();
      let used = 0, extras = 0, withDupes = 0;
      for (const [afd, arr] of byAfd.entries()){
        let chosen;
        if (arr.length > 1){
          withDupes++;
          chosen = arr.find(x => isOAI1(x.oai)) ?? arr[0];
          extras += (arr.length - 1);
        } else {
          chosen = arr[0];
        }
        out.set(afd, chosen);
        used++;
      }
      return { out, used, extras, withDupes };
    }

    function renderTable(map){
      tbody.innerHTML = '';
      const rows = Array.from(map.values()).slice(0, 250);
      for (const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.afd}</td><td>${r.anva}</td><td>${r.oms}</td><td>${r.afwijk}</td><td>${isOAI1(r.oai) ? 'OAI=1' : (r.oai ?? '')}</td>`;
        tbody.appendChild(tr);
      }
      tbl.hidden = rows.length === 0;
    }

    function download(filename, text){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'}));
      a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    }

    function toCsv(map){
      const rows = [['AFD','ANVA','ANVA Omschrijving','Afwijkend niet toegestaan','OAI']];
      for (const r of map.values()){
        rows.push([r.afd, r.anva, r.oms, r.afwijk, isOAI1(r.oai)?'1':(r.oai??'')]);
      }
      return rows.map(r => r.map(v => String(v).includes(',') ? '"'+String(v).replaceAll('"','""')+'"' : String(v)).join(',')).join('\n');
    }

    qs('#buildBtn').addEventListener('click', async () => {
      logEl.hidden = false; logEl.textContent='⏳ Bezig met inlezen…'; statsEl.innerHTML = '';
      mapping = new Map();
      try{
        const anvaFile = qs('#anvaFile').files[0];
        const codelistFile = qs('#codelistFile').files[0];
        const dataFile = qs('#dataFile').files[0];

        // ANVA verplicht
        anvaRows = await readXlsx(anvaFile);
        const { out, used, extras, withDupes } = buildMappingFromAnvaRows(anvaRows);
        mapping = out;

        addStat('Mappings', used, 'success');
        addStat('AFD met duplicaten', withDupes, withDupes ? 'warn' : '');
        addStat('Extra rijen genegeerd (de-dupe)', extras, extras ? 'warn' : '');

        if (codelistFile){
          const codes = await readCsv(codelistFile);
          addStat('Codelist regels', codes.length);
        }
        if (dataFile){
          const dataRows = await readCsv(dataFile);
          addStat('Data regels', dataRows.length);
        }

        renderTable(mapping);
        qs('#dlCsvBtn').disabled = false;
        qs('#dlJsonBtn').disabled = false;
        logEl.textContent = '✅ Klaar. Toegepaste regel: bij duplicaten krijgt OAI=1 prioriteit; bij unieke AFD wordt OAI genegeerd.';
      }catch(err){
        console.error(err);
        logEl.textContent = '❌ Fout: '+ err.message;
      }
    });

    qs('#dlCsvBtn').addEventListener('click', () => {
      const csv = toCsv(mapping);
      download('anva_mapping.csv', csv);
    });
    qs('#dlJsonBtn').addEventListener('click', () => {
      const obj = Array.from(mapping.values());
      download('anva_mapping.json', JSON.stringify(obj, null, 2));
    });

    setReadyState();
  </script>
</body>
</html>
